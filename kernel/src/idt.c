#include "../kernel.h"
#include "idt.h"
#include "debug.h"
#include "io.h"

idt_entry_t *_idt = (idt_entry_t*)HARDWARE_MEM_IDT_TABLE;

static void _idt_setup(int num, uint32_t function)
{
    IO_STORE_FLAGS();
    io_disable_int();
    _idt[num].base_lower = function & 0xffff;
    _idt[num].base_upper = (function>>16) & 0xffff;
    _idt[num].selector = 0x8;
    _idt[num].flags = 0x8e;
    IO_RESTORE_FLAGS();
}

void idt_init()
{
    IDT_HANDLER(0000);
    IDT_HANDLER(0001);
    IDT_HANDLER(0002);
    IDT_HANDLER(0003);
    IDT_HANDLER(0004);
    IDT_HANDLER(0005);
    IDT_HANDLER(0006);
    IDT_HANDLER(0007);
    IDT_HANDLER(0010);
    IDT_HANDLER(0011);
    IDT_HANDLER(0012);
    IDT_HANDLER(0013);
    IDT_HANDLER(0014);
    IDT_HANDLER(0015);
    IDT_HANDLER(0016);
    IDT_HANDLER(0017);
    IDT_HANDLER(0020);
    IDT_HANDLER(0021);
    IDT_HANDLER(0022);
    IDT_HANDLER(0023);
    IDT_HANDLER(0024);
    IDT_HANDLER(0025);
    IDT_HANDLER(0026);
    IDT_HANDLER(0027);
    IDT_HANDLER(0030);
    IDT_HANDLER(0031);
    IDT_HANDLER(0032);
    IDT_HANDLER(0033);
    IDT_HANDLER(0034);
    IDT_HANDLER(0035);
    IDT_HANDLER(0036);
    IDT_HANDLER(0037);
    IDT_HANDLER(0040);
    IDT_HANDLER(0041);
    IDT_HANDLER(0042);
    IDT_HANDLER(0043);
    IDT_HANDLER(0044);
    IDT_HANDLER(0045);
    IDT_HANDLER(0046);
    IDT_HANDLER(0047);
    IDT_HANDLER(0050);
    IDT_HANDLER(0051);
    IDT_HANDLER(0052);
    IDT_HANDLER(0053);
    IDT_HANDLER(0054);
    IDT_HANDLER(0055);
    IDT_HANDLER(0056);
    IDT_HANDLER(0057);
    IDT_HANDLER(0060);
    IDT_HANDLER(0061);
    IDT_HANDLER(0062);
    IDT_HANDLER(0063);
    IDT_HANDLER(0064);
    IDT_HANDLER(0065);
    IDT_HANDLER(0066);
    IDT_HANDLER(0067);
    IDT_HANDLER(0070);
    IDT_HANDLER(0071);
    IDT_HANDLER(0072);
    IDT_HANDLER(0073);
    IDT_HANDLER(0074);
    IDT_HANDLER(0075);
    IDT_HANDLER(0076);
    IDT_HANDLER(0077);

    IDT_HANDLER(0100);
    IDT_HANDLER(0101);
    IDT_HANDLER(0102);
    IDT_HANDLER(0103);
    IDT_HANDLER(0104);
    IDT_HANDLER(0105);
    IDT_HANDLER(0106);
    IDT_HANDLER(0107);
    IDT_HANDLER(0110);
    IDT_HANDLER(0111);
    IDT_HANDLER(0112);
    IDT_HANDLER(0113);
    IDT_HANDLER(0114);
    IDT_HANDLER(0115);
    IDT_HANDLER(0116);
    IDT_HANDLER(0117);
    IDT_HANDLER(0120);
    IDT_HANDLER(0121);
    IDT_HANDLER(0122);
    IDT_HANDLER(0123);
    IDT_HANDLER(0124);
    IDT_HANDLER(0125);
    IDT_HANDLER(0126);
    IDT_HANDLER(0127);
    IDT_HANDLER(0130);
    IDT_HANDLER(0131);
    IDT_HANDLER(0132);
    IDT_HANDLER(0133);
    IDT_HANDLER(0134);
    IDT_HANDLER(0135);
    IDT_HANDLER(0136);
    IDT_HANDLER(0137);
    IDT_HANDLER(0140);
    IDT_HANDLER(0141);
    IDT_HANDLER(0142);
    IDT_HANDLER(0143);
    IDT_HANDLER(0144);
    IDT_HANDLER(0145);
    IDT_HANDLER(0146);
    IDT_HANDLER(0147);
    IDT_HANDLER(0150);
    IDT_HANDLER(0151);
    IDT_HANDLER(0152);
    IDT_HANDLER(0153);
    IDT_HANDLER(0154);
    IDT_HANDLER(0155);
    IDT_HANDLER(0156);
    IDT_HANDLER(0157);
    IDT_HANDLER(0160);
    IDT_HANDLER(0161);
    IDT_HANDLER(0162);
    IDT_HANDLER(0163);
    IDT_HANDLER(0164);
    IDT_HANDLER(0165);
    IDT_HANDLER(0166);
    IDT_HANDLER(0167);
    IDT_HANDLER(0170);
    IDT_HANDLER(0171);
    IDT_HANDLER(0172);
    IDT_HANDLER(0173);
    IDT_HANDLER(0174);
    IDT_HANDLER(0175);
    IDT_HANDLER(0176);
    IDT_HANDLER(0177);

    IDT_HANDLER(0200);
    IDT_HANDLER(0201);
    IDT_HANDLER(0202);
    IDT_HANDLER(0203);
    IDT_HANDLER(0204);
    IDT_HANDLER(0205);
    IDT_HANDLER(0206);
    IDT_HANDLER(0207);
    IDT_HANDLER(0210);
    IDT_HANDLER(0211);
    IDT_HANDLER(0212);
    IDT_HANDLER(0213);
    IDT_HANDLER(0214);
    IDT_HANDLER(0215);
    IDT_HANDLER(0216);
    IDT_HANDLER(0217);
    IDT_HANDLER(0220);
    IDT_HANDLER(0221);
    IDT_HANDLER(0222);
    IDT_HANDLER(0223);
    IDT_HANDLER(0224);
    IDT_HANDLER(0225);
    IDT_HANDLER(0226);
    IDT_HANDLER(0227);
    IDT_HANDLER(0230);
    IDT_HANDLER(0231);
    IDT_HANDLER(0232);
    IDT_HANDLER(0233);
    IDT_HANDLER(0234);
    IDT_HANDLER(0235);
    IDT_HANDLER(0236);
    IDT_HANDLER(0237);
    IDT_HANDLER(0240);
    IDT_HANDLER(0241);
    IDT_HANDLER(0242);
    IDT_HANDLER(0243);
    IDT_HANDLER(0244);
    IDT_HANDLER(0245);
    IDT_HANDLER(0246);
    IDT_HANDLER(0247);
    IDT_HANDLER(0250);
    IDT_HANDLER(0251);
    IDT_HANDLER(0252);
    IDT_HANDLER(0253);
    IDT_HANDLER(0254);
    IDT_HANDLER(0255);
    IDT_HANDLER(0256);
    IDT_HANDLER(0257);
    IDT_HANDLER(0260);
    IDT_HANDLER(0261);
    IDT_HANDLER(0262);
    IDT_HANDLER(0263);
    IDT_HANDLER(0264);
    IDT_HANDLER(0265);
    IDT_HANDLER(0266);
    IDT_HANDLER(0267);
    IDT_HANDLER(0270);
    IDT_HANDLER(0271);
    IDT_HANDLER(0272);
    IDT_HANDLER(0273);
    IDT_HANDLER(0274);
    IDT_HANDLER(0275);
    IDT_HANDLER(0276);
    IDT_HANDLER(0277);

    IDT_HANDLER(0300);
    IDT_HANDLER(0301);
    IDT_HANDLER(0302);
    IDT_HANDLER(0303);
    IDT_HANDLER(0304);
    IDT_HANDLER(0305);
    IDT_HANDLER(0306);
    IDT_HANDLER(0307);
    IDT_HANDLER(0310);
    IDT_HANDLER(0311);
    IDT_HANDLER(0312);
    IDT_HANDLER(0313);
    IDT_HANDLER(0314);
    IDT_HANDLER(0315);
    IDT_HANDLER(0316);
    IDT_HANDLER(0317);
    IDT_HANDLER(0320);
    IDT_HANDLER(0321);
    IDT_HANDLER(0322);
    IDT_HANDLER(0323);
    IDT_HANDLER(0324);
    IDT_HANDLER(0325);
    IDT_HANDLER(0326);
    IDT_HANDLER(0327);
    IDT_HANDLER(0330);
    IDT_HANDLER(0331);
    IDT_HANDLER(0332);
    IDT_HANDLER(0333);
    IDT_HANDLER(0334);
    IDT_HANDLER(0335);
    IDT_HANDLER(0336);
    IDT_HANDLER(0337);
    IDT_HANDLER(0340);
    IDT_HANDLER(0341);
    IDT_HANDLER(0342);
    IDT_HANDLER(0343);
    IDT_HANDLER(0344);
    IDT_HANDLER(0345);
    IDT_HANDLER(0346);
    IDT_HANDLER(0347);
    IDT_HANDLER(0350);
    IDT_HANDLER(0351);
    IDT_HANDLER(0352);
    IDT_HANDLER(0353);
    IDT_HANDLER(0354);
    IDT_HANDLER(0355);
    IDT_HANDLER(0356);
    IDT_HANDLER(0357);
    IDT_HANDLER(0360);
    IDT_HANDLER(0361);
    IDT_HANDLER(0362);
    IDT_HANDLER(0363);
    IDT_HANDLER(0364);
    IDT_HANDLER(0365);
    IDT_HANDLER(0366);
    IDT_HANDLER(0367);
    IDT_HANDLER(0370);
    IDT_HANDLER(0371);
    IDT_HANDLER(0372);
    IDT_HANDLER(0373);
    IDT_HANDLER(0374);
    IDT_HANDLER(0375);
    IDT_HANDLER(0376);
    IDT_HANDLER(0377);

    io_setup_idt(sizeof(idt_entry_t) * 256);
}

extern void _idt_handler(regs_t regs);

__asm__(
    "_idt_global_handler:\n"
    ".globl _idt_global_handler\n"
    "pusha\n"
    "mov %ds, %bx\n"
    "push %ebx\n"
    "mov $0x10, %bx\n"
    "mov %bx, %ds\n"
    "mov %bx, %es\n"
    "mov %bx, %fs\n"
    "mov %bx, %gs\n"
    "call _idt_handler\n"
    "pop %ebx\n"
    "mov %bx, %ds\n"
    "mov %bx, %es\n"
    "mov %bx, %fs\n"
    "mov %bx, %gs\n"
    "popa\n"
    "add $8, %esp\n"
    "sti\n"
    "iret"

);
